#!/bin/bash

create_bug_self_failure() {
    BUGZILLA_API_KEY="<%= @bugzilla_api_key %>"
    logfile="<%= @log_file %>"
    product="Infrastructure & Operations"
    component="CIDuty"
    # Provide last20 lines from the log, and put this information into the bug
    log=`tail -20 $logfile|grep generic-worker`
    summary="Generic worker on host <%= @fqdn %> returned exit code 69"
    description="Error code 69 means: worker panic - either a worker bug, or the environment is not suitable for running
                a task, e.g. a file cannot be written to the file system, or something else did
                not work that was required in order to execute a task. See config setting
                shutdownMachineOnInternalError.

                The following log were provided:
                "$log""
    bugzilla_url="<%= @bugzilla_url %>"
    
    JSON=$(cat << EOF
    {
       "api_key": "$BUGZILLA_API_KEY",
       "product" : "$product",
       "component" : "$component",
       "version" : "unspecified",
       "summary" : "$summary",
       "description": "$description"
   }
)
echo "$JSON" > $json_file

curl -X 'POST' -H Content-Type:application/json -H Accept:application/json -d @$json_file $bugzilla_url/rest/bug -o 'id_bug'
sed -i -e 's/}//g' 

}


resolve_bug_self_failure() {
    bug_id=`awk -F: '{print $2}' id_bug`
    
}
