#!/bin/bash

# This is a wrapper script for calling generic worker, such that when the worker
# exits, this script will reboot the machine. Note, in the worker config
# (/etc/generic-worker.config) we set numberOfTasksToRun to 1 so that the worker
# will exit after running a single task. This script is then responsible for
# rebooting the machine.

# If this file exists when the worker starts up, and its content is equal
# to numberOfTasksToRun, the worker won't exit and machine won't reboot.
rm -f tasks-resolved-count.txt

# First run the generic-worker, passing through any arguments handed to this
# wrapper script...
/usr/local/bin/generic-worker "$@" 2>&1 | logger -t generic-worker -s

exitstatus=( ${PIPESTATUS[0]} )

echo $exitstatus

export TASKCLUSTER_CLIENT_ID="<%= @quarantine_client_id %>"
export TASKCLUSTER_ACCESS_TOKEN="<%= @quarantine_access_token %>"

if [ $exitstatus -eq 69 ]; then
    if [ -f /Users/cltbld/quarantined ]; then
        echo "Worker is quarantined"
    else
        echo "Quarantine worker"
        # quarantine the worker
        /usr/local/bin/quarantine-worker releng-hardware "<%= @worker_type %>" "<%= @worker_group %>" "<%= @hostname %>" 720h5s
        # create the bug

        # create a semaphore file
        echo "quarantined worker" > /Users/cltbld/quarantined
        # create the bug
    fi
elif [ -f /Users/cltbld/quarantined ]; then

    # if the worker was in quarantine, but now the exitcode is other that 69
    # remove worker from quarantine
    /usr/local/bin/quarantine-worker releng-hardware "<%= @worker_type %>" "<%= @worker_group %>" "<%= @hostname %>" 0s

    # close the bug

    # remove the semaphore file

    /bin/rm -rf /Users/cltbld/quarantined
fi

# Now reboot the machine immediately (time costs money)
/usr/bin/sudo /sbin/reboot
# Sleep to prevent this script from terminating naturally, and launchd restarting
# it. Instead, the shutdown should cause this script to terminate (so it won't
# really sleep for 2 mins). If shutdown doesn't kick in within 2 mins, it is sane
# for this script to exit, and allow launchd to fire up the worker again.
/bin/sleep 120
